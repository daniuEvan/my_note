# 昨日内容回顾

- es是啥
- 环境安装
- 数据组织
  - 物理：节点和分片
  - 逻辑：索引、类型、文档
- 简单操作
  - GET
  - PUT
  - DELETE

```
GET _search
{
  "query": {
    "match_all": {}
  }
}


# day111-----------------

PUT s18/doc/1
{
  "name":"大刀"
}



PUT s18/doc/2
{
  "name":"鹏程"
}



PUT s18/doc/3
{
  "name":"laowang"
}



GET s18/doc/_search?q=name:laowang

GET s18/doc/_search


DELETE s18/doc/1
DELETE s18


GET s18/_mapping
GET s18/_settings
GET s18






# ------- day112 ----------------

# es的增删改查

DELETE s18

PUT s18/doc/1
{
  "name":"yangyazhou",
  "age": 81,
  "sex": "男",
  "tags": "闷骚",
  "b": "19900715"
}

PUT s18/doc/2
{
  "name":"yangtao",
  "age": 18,
  "sex": "男",
  "tags":"浪",
  "b": "19970521"
}

PUT s18/doc/3
{
  "name":"cancan",
  "age": 16,
  "sex":"女",
  "tags":"学习认真",
  "b":"19980101"
}

PUT s18/doc/4
{
  "name":"guchenxu",
  "age": 22,
  "sex": "男",
  "tags":"幽默",
  "b":"19930302"
}

PUT s18/doc/5
{
  "name":"yangwenyu",
  "age": 23,
  "sex": "男",
  "tags":"正人君子",
  "b":"19941201"
}


GET s18/doc/1


GET s18/doc/_search



# 查询字符串 query string
GET s18/doc/_search?q=age:22



PUT s18/doc/5
{
  "tags":"帅气"
}

GET s18/doc/5



# 修改指定字段使用POST
POST s18/doc/5/_update
{
  "doc": {
    "tags":"帅气"
  }
}


DELETE s18/doc/5

DELETE s18


POST s18/doc/_delete_by_query?q=age:18


# 查询的两种方式
# 查询字符串 query string
GET s18/doc/_search?q=age:22

# DSL

GET s18/doc/_search
{
  "query": {
    "match": {
      "age": "18"
    }
  }
}

GET s18/doc/_search
{
  "query": {
    "match": {
      "age": 18
    }
  }
}



# 报错
GET s18/doc/_search
{
  "query": {
    "match": {
      "tags": ["浪", "闷骚"]
    }
  }
}




GET s18/doc/_search
{
  "query": {
    "match": {
      "tags": "浪 闷骚"
    }
  }
}





GET s18/doc/_search


GET s18/doc/_search
{
  "query": {
    "match_all": {}
  }
}

# 排序 sort




GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "age": {
        "order": "desc"
      }
    }
  ]
}


GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "age": {
        "order": "asc"
      }
    }
  ]
}


# 不是所有的字段都能排序
GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "b": {
        "order": "asc"
      }
    }
  ]
}



# 分页

GET s18/doc/_search
GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "from": 0,
  "size": 2
}



GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "from": 2,
  "size": 2
}





GET s18/doc/_search

GET s18/doc/_search
{
  "query": {
    "match_all": {}
  },
  "from": 4,
  "size": 10
}


# 布尔查询bool: should(or) must(and) must_not(not)
GET s18/doc/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "name": "yangwenyu"
          }
        },
        {
          "match": {
            "age": "18"
          }
        }
      ]
    }
  }
}


#查询性别是男的，年龄81
GET s18/doc/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "age": 81
          }
        },
        {
          "match": {
            "sex": "男"
          }
        }
      ]
    }
  }
}


# 查询性别既不是男的，又不是18岁： must_not
GET s18/doc/_search
{
  "query": {
    "bool": {
      "must_not": [
        {
          "match": {
            "sex": "男"
          }
        },
        {
          "match": {
            "age": 18
          }
        }
      ]
    }
  }
}


# 查询年龄大于20岁的男的文档: gt 大于
GET s18/doc/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "sex": "男"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "gt": 20
          }
        }
      }
    }
  }
}



# gte 大于等于，查询年龄大于等于23的男的
GET s18/doc/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "sex": "男"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "gte": 23
          }
        }
      }
    }
  }
}


# 小于lt 查询年龄小于20的女的

GET s18/doc/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "sex": "女"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
              "lt": 20
          }
        }
      }
    }
  }
}


# 小于等于lte， 查询年龄小于等于23的男的

GET s18/doc/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "sex": "男"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "lte": 23
          }
        }
      }
    }
  }
}

# filter中尽量用must，避免脏数据
GET s18/doc/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "sex": "男"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "lte": 23
          }
        }
      }
    }
  }
}

# 查询年龄小于等于23的非男性

GET s18/doc/_search
{
  "query": {
    "bool": {
      "must_not": [
        {
          "match": {
            "sex": "男"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "lte": 23
          }
        }
      }
    }
  }
}



# 高亮查询
# 查询name是cancan的文档
GET s18/doc/_search
{
  "query": {
    "match": {
      "name": "cancan"
    }
  },
  "highlight": {
    "fields": {
      "name": {}
    }
  }
}


GET s18/doc/_search
{
  "query": {
    "match": {
      "name": "cancan"
    }
  },
  "highlight": {
    "pre_tags": "<b style='color:red;font-size:20px;' class='wangdi'>", 
    "post_tags": "</b>", 
    "fields": {
      "name": {}
    }
  }
}






PUT s18/doc/6
{
  "name":"wangdi",
  "desc": "骚的打漂"
}


GET s18/doc/_search
{
  "query": {
    "match": {
      "desc": "打漂"
    }
  },
  "highlight": {
    "pre_tags": "<b style='color:red;font-size:20px;' class='wangdi'>", 
    "post_tags": "</b>", 
    "fields": {
      "desc": {}
    }
  }
}



# 结果过滤

GET s18/doc/_search
{
  "query": {
    "match": {
      "name": "yangtao"
    }
  },
  "_source": "name"
}

GET s18/doc/_search
{
  "query": {
    "match": {
      "name": "yangtao"
    }
  },
  "_source": ["name", "age", "sex"]
}




# 聚合查询

# sum,查询所有男生的年龄总和
GET s18/doc/_search
{
  "query": {
    "match": {
      "sex": "男"
    }
  },
  "aggs": {
    "my_sum": {
      "sum": {
        "field": "age"
      }
    }
  }
}


# 查询年龄最大的男生 max
GET s18/doc/_search
{
  "query": {
    "match": {
      "sex": "男"
    }
  },
  "aggs": {
    "my_max": {
      "max": {
        "field": "age"
      }
    }
  }
}


# 查询年龄最小的 min

GET s18/doc/_search
{
  "aggs": {
    "my_min": {
      "min": {
        "field": "age"
      }
    }
  }
}

# 求平均 avg
GET s18/doc/_search
{
  "aggs": {
    "my_avg": {
      "avg": {
        "field": "age"
      }
    }
  }
}


# 分组，根据年龄，10-20，,20-30， 30-100
GET s18/doc/_search
{
  "query": {
    "match": {
      "sex": "男"
    }
  },
  "aggs": {
    "my_group":{
      "range": {
        "field": "age",
        "ranges": [
          {
            "from": 10,
            "to": 20
          },
          {
            "from": 20,
            "to": 30
          },
          {
            "from": 30,
            "to": 100
          }
        ]
      }
    }
  }
}



# 分组，根据年龄，10-20，,20-30， 30-100， 对每组年龄求和
GET s18/doc/_search
{
  "query": {
    "match": {
      "sex": "男"
    }
  },
  "aggs": {
    "group":{
      "range": {
        "field": "age",
        "ranges": [
          {
            "from": 10,
            "to": 20
          },
          {
            "from": 20,
            "to": 30
          },
          {
            "from": 30,
            "to": 100
          }
        ]
      },
      "aggs": {
        "my_sum": {
          "sum": {
            "field": "age"
          }
        }
      }
    }
  }
}



# mappings
PUT s2
{
  "mappings": {
    "doc":{
      "properties":{
        "name":{
          "type":"text"
        },
        "age":{
          "type": "long"
        },
        "desc":{
          "type":"text"
        }
      }
    }
  }
}

GET s18/_mapping
GET s2/_mapping

PUT s2/doc/1
{
  "name":"zining",
  "age": 21,
  "desc":"低调"
}

PUT s2/doc/2
{
  "name":"jinxing",
  "age": 22,
  "desc":"金老板的表弟",
  "tags":"帅"
}


GET s2/doc/_search
{
  "query": {
    "match": {
      "tags": "帅"
    }
  }
}



GET s2/doc/_search


PUT s3
{
    "mappings" : {
      "doc" : {
        "properties" : {
          "age" : {
            "type" : "long"
          },
          "b" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          },
          "desc" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          },
          "name" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          },
          "sex" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          },
          "tags" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          }
        }
      }
    }
}


# mapping的dynamic的三种状态

PUT s4
{
  "mappings": {
    "doc":{
      "dynamic": true,
      "properties":{
        "name":{
          "type":"text"
        }
      }
    }
  }
}





PUT s5
{
  "mappings": {
    "doc":{
      "dynamic": false,
      "properties":{
        "name":{
          "type":"text"
        }
      }
    }
  }
}


PUT s5/doc/1
{
  "name":"玉冰"
}

PUT s5/doc/2
{
  "name":"peiqin",
  "age": 17
}

PUT s5/doc/3
{
  "age": 18
}



GET s5/_mapping
GET s5/doc/_search

{
  "query": {
    "match": {
      "name": "玉冰"
    }
  }
}


GET s5/doc/_search
{
  "query": {
    "match": {
      "age": 17
    }
  }
}



# dynamic:strict

# 报错，在创建mapping的时候，必须添加类型（doc）
PUT s6
{
  "mappings": {
    
    "dynamic": "strict",
    "properties": {
      "name":{
        "type": "text"
      }
    }
  }
}



PUT s6
{
  "mappings": {
    "doc":{
      "dynamic":"strict",
      "properties":{
        "name":{
          "type":"text"
        }
      }
    }
  }
}

PUT s6/doc/1
{
  "name":"he"
}

PUT s6/doc/2
{
  "name":"qiao",
  "age": 23
}



GET s6/doc/_search
{
  "query": {
    "match": {
      "name": "he"
    }
  }
}

GET s6/_mapping



DELETE s7


# mapping的ignore_above
PUT s7
{
  "mappings": {
    "doc":{
      "properties":{
        "title":{
          "type":"keyword",
          "ignore_above": 10
        }
      }
    }
  }
}





PUT s7/doc/1
{
  "title": "从手机、平板电脑、路由器和视频游戏控制台"
}


PUT s7/doc/2
{
  "title": "1234567"
}

PUT s7/doc/3
{
  "title":"中关村"
}

GET s7/doc/_search
{
  "query": {
    "match": {
      "title": "1234567"
    }
  }
}




GET s7/doc/_search
{
  "query": {
    "match": {
      "title": "中关村"
    }
  }
}





GET s7/_mapping




# mappings参数index

PUT s8
{
  "mappings": {
    "doc":{
      "properties":{
        "t1":{
          "type":"text",
          "index": true
        },
        "t2":{
          "type":"text",
          "index": false
        }
      }
    }
  }
}


PUT s8/doc/1
{
  "t1":"论母猪的产前保养",
  "t2":"论母猪的产后护理"
}


GET s8/doc/_search
{
  "query": {
    "match": {
      "t1": "母猪"
    }
  }
}

GET s8/doc/_search
{
  "query": {
    "match": {
      "t2": "母猪"
    }
  }
}


# copy_to

PUT s9
{
  "mappings": {
    "doc":{
      "properties":{
        "t1":{
          "type":"text",
          "copy_to":"full_name"
        },
        "t2":{
          "type":"text",
          "copy_to":"full_name"
        },
        "full_name":{
          "type":"text"
        }
      }
    }
  }
}


PUT s9/doc/1
{
  "t1":"xxx",
  "t2":"ooo"
}


GET s9/doc/_search
{
  "query": {
    "match": {
      "t1": "xxx"
    }
  }
}


GET s9/doc/_search
{
  "query": {
    "match": {
      "full_name": "xxx"
    }
  }
}


PUT s10
{
  "mappings": {
    "doc":{
      "properties":{
        "t1":{
          "type":"text",
          "copy_to":["f1", "f2"]
        },
        "t2":{
          "type":"text",
          "copy_to":["f1", "f2"]
        },
        "f1":{
          "type":"text"
        },
        "f2":{
          "type":"keyword"
        }
      }
    }
  }
}

# 嵌套类型

PUT w1
{
  "mappings": {
    "doc":{
      "properties":{
        "name":{
          "type":"text"
        },
        "age":{
          "type":"long"
        },
        "info":{
          "properties":{
            "addr":{
              "type":"text"
            },
            "tel":{
              "type":"long"
            }
          }
        }
      }
    }
  }
}

GET w1/_mapping

PUT w1/doc/1
{
  "name":"tom",
  "age":18,
  "info":{
    "addr":"北京",
    "tel":"10010"
  }
}


PUT w1/doc/2
{
  "name":"tom",
  "age":"18",
  "info":{
    "addr":"北京",
    "tel":"10010"
  }
}

GET w1/doc/2

GET w1/doc/_search
{
  "query": {
    "match": {
      "info.tel": "10010"
    }
  }
}

GET w1/doc/_search
{
  "query": {
    "match": {
      "age": "18"
    }
  }
}


GET w1

PUT w2
{
  "mappings": {
    "doc":{
      "properties":{
        "title":{
          "type":"text"
        }
      }
    }
  }, 
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 3
  }
}

GET w2
```



